<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<title>New document</title>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
	<script type="text/javascript" src="scripts/jQueryRotate.2.2.js"></script>
	<script type="text/javascript" src="scripts/jquery.path.js"></script>
	<link rel="stylesheet" type="text/css" href="css/mlpstyle.css" />
</head>

<script type="text/javascript">
	
	/* global variables */
	var curHour = 0, curMin = 0, curSec = 0;
	var oldHour = 0, oldMin = 0, oldSec = 0;
	var everySec = 1000, everyMin = 1000 * 60, everyHour = 1000 * 60 * 60;
	$(document).ready(function () {

		/////////////////////////////////
		// DEBUG  functions
		/////////////////////////////////
		$(':button[id="hr_plus"]').click(function () {
			curHour++;
			curHour %= 24;
		});
		$(':button[id="hr_minus"]').click(function () {
			curHour--;
			if (curHour < 0) {
				curHour = 23;
			}
		});
		//////////////////////////

		updateClock();
		$(".frame").show();
		$("#canvas").show();

		//setInterval(moveSkyObjects, 3000);
		//setInterval(windmillSecondTick, 1000);

		//debug kick start first hour for nicer effect
		curHour++;

		setInterval(displayTextTime, 100);
		setInterval(updateClock, everySec);

	});

	/* main clock logic */
	var updateClock = function () {
		//dubug: disabled time update, currently controlled via buttons
		//getTime();
		checkForHourlyChange();
		checkForMinChange();
		checkForSecChange();
	}

	function getTime() {
		var now = new Date();
		curHour = now.getHours();
		curMin  = now.getMinutes();
		curSec  = now.getSeconds();
	}

	function checkForHourlyChange() {
		if (oldHour != curHour) {
			oldHour = curHour;
			//list of all functions to simulate passing hour
			moveSkyObjects();
		}
		//else: nothing to do here
	}
	function checkForMinChange() {
		if (oldMin != curMin) {
			oldMin = curMin;
			//list of all functions to simulate passing min
		}
		//else: nothing to do here
	}
	function checkForSecChange() {
		/* every secon always passes test in current implementation
		if (oldSec != curSec) {
			oldSec = curSec;
			//list of all functions to simulate passing sec
		}
		*/
		//list of all functions to simulate passing sec
		windmillSecondTick();
	}

	var bladeAngle = 1;
	var bladeTickDuration = 100;
	function windmillSecondTick() {
		$(".blades").rotate({angle: bladeAngle,
							 animateTo: bladeAngle + 20,
							 duration: bladeTickDuration});
		//handle angles > 360 deg
		bladeAngle = (bladeAngle + 20) % 360;
	}

	var noOfHours = 24;
	var moveAngle = 5;
	var moveSpeed = 200, starMoveSpeed = 2000;
	var coorIdx = 0, nextCoorIdx = 0;
	var sunCoorX = [57,  85,  130, 185, 256, 346, 448, 535, 599, 662, 727, 779, 830 ,872, 914 ,952, 984];
	var sunCoorY = [442, 370, 305, 229, 160, 102, 65,  51,  60,  72,  97,  125, 158, 197, 241, 286, 341];
	var moonCoorX = [39, 92, 158, 238, 328, 434, 525, 618, 713, 797, 871, 932, 999];
	var moonCoorY = [420, 309, 219, 143, 85, 49, 36, 49, 83, 130, 198, 271, 403];
	var starsCoorX = [39, 92, 158, 238, 328, 434, 525, 618, 713, 797, 871, 932, 999];
	var starsCoorY = [420, 309, 219, 143, 85, 49, 36, 49, 83, 130, 198, 271, 403];
	var starsCoorX = [35, 40, 45, 50, 55, 60, 65, 70, 75, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 10, 15, 20, 25, 30];
	var starsCoorY = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

	var skyDayFadeAmount = [0, 0, 0, 0.2, 0.4, 0.6, 0.8, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.8, 0.6, 0.4, 0.2, 0, 0];
	var backgroundFadeAmount = [0, 0, 0, 0.1, 0.3, 0.5, 0.7, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.7, 0.5, 0.2, 0, 0];
	var midgroundFadeAmount = [0, 0, 0, 0, 0.1, 0.3, 0.5, 0.7, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.7, 0.5, 0.3, 0, 0, 0];
	var foregroundFadeAmount = [0, 0, 0, 0, 0, 0.1, 0.3, 0.5, 0.7, 1, 1, 1, 1, 1, 1, 1, 1, 0.7, 0.5, 0.3, 0, 0, 0, 0];

	var bezier_params = 0;
	var moveSkyObjects = function () {
		//check if within sun movement hours
		if (curHour > 5 && curHour < 22) {
			coorIdx = curHour - 6;
			nextCoorIdx = coorIdx + 1;

			bezier_params = {
				start: { x: sunCoorX[coorIdx], y: sunCoorY[coorIdx], angle: -moveAngle, length: 0.5 },
				end: { x: sunCoorX[nextCoorIdx], y: sunCoorY[nextCoorIdx], angle: moveAngle, length: 0.5 }};

			$("#sun").animate({ path: new $.path.bezier(bezier_params) }, moveSpeed);
		}

		//check if within  moon movement hours
		if (curHour > 18 || curHour < 7) {
			//handle hour change from 23 -> 0
			if (curHour > 18) {
				coorIdx = curHour - 19;
				nextCoorIdx = coorIdx + 1;
			} else {
				coorIdx = curHour + 5;
				nextCoorIdx = coorIdx + 1;
			}

			bezier_params = {
				start: { x: moonCoorX[coorIdx], y: moonCoorY[coorIdx], angle: -moveAngle, length: 0.5 },
				end: { x: moonCoorX[nextCoorIdx], y: moonCoorY[nextCoorIdx], angle: moveAngle, length: 0.5 }};
		
			$("#moon").animate({ path: new $.path.bezier(bezier_params) }, moveSpeed);
		}

		//move Stars
		//TODO: fix coordinates when simplifing moon and sun
		coorIdx = curHour;
		if (curHour == 23) {
			nextCoorIdx = 0;
		} else {
			nextCoorIdx = coorIdx + 1;
		}
				
		bezier_params = {
			start: { x: starsCoorX[coorIdx], y: starsCoorY[coorIdx], angle: 0, length: 1 },
			end: { x: starsCoorX[nextCoorIdx], y: starsCoorY[nextCoorIdx], angle: 0, length: 1 }
		};
		
		//$("#stars").animate({ path: new $.path.bezier(bezier_params) }, moveSpeed);
		$("#stars").animate({ left: starsCoorX[coorIdx] }, moveSpeed);

		//handle lightening up and darkening sky
		$(".sky_day").fadeTo(		"slow", skyDayFadeAmount[curHour]);
		$(".foreground_day").fadeTo("slow", foregroundFadeAmount[curHour]);
		$(".midground_day").fadeTo(	"slow", midgroundFadeAmount[curHour]);
		$(".background_day").fadeTo("slow", backgroundFadeAmount[curHour]);
		$(".blades_day").fadeTo(	"slow", foregroundFadeAmount[curHour]);
	}

	var displayTextTime = function () {
		$("#timeDisplay").text("" + curHour + ":" + curMin);
	}

</script>
<body>
	<div id="timeDisplay">		aaa												</div>
	<div id="hourBtn">			<button  id="hr_plus">	hour++	</button>		</div>
	<div id="Div1">				<button  id="hr_minus">	hour--	</button>		</div>

	<div id="canvas">
		<div class="frame sky_day">
			<img src="imgs/skyDay.png" />		</div>
		<div class="frame sky_night">
			<img src="imgs/skyNight.png" />		</div>


		<div class="frame foreground_day bottom_pos">
			<img src="imgs/foreground_day.png" />			</div>
		<div class="frame foreground_night bottom_pos">
			<img src="imgs/foreground_night.png" />			</div>

		<div class="frame midground_day bottom_pos">
			<img src="imgs/midground_day.png" />			</div>
		<div class="frame midground_night bottom_pos">
			<img src="imgs/midground_night.png" />			</div>

		<div class="frame background_day ">
			<img src="imgs/background_day.png" />			</div>
		<div class="frame background_night ">
			<img src="imgs/background_night.png" />			</div>

		<div class="frame blades blades_day">
			<img src="imgs/blades_day.png" />		</div>
		<div class="frame blades blades_night">
			<img src="imgs/blades_night.png" />		</div>

		<div class="frame" id="sun">
			<img src="imgs/sun.png" />			</div>
		<div class="frame" id="moon">
			<img src="imgs/moon.png" />			</div>
		<div class="frame" id="stars">
			<img src="imgs/stars.png" />		</div>
	</div>
</body>
</html>