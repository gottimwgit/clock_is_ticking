<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<title>New document</title>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
	<script type="text/javascript" src="scripts/jQueryRotate.2.2.js"></script>
	<script type="text/javascript" src="scripts/jquery.path.js"></script>
	<link rel="stylesheet" type="text/css" href="css/mlpstyle.css" />
</head>

<script type="text/javascript">
	
	/* global variables */
	var curHour = 0, curMin = 0, curSec = 0;
	var oldHour = 0, oldMin = 0, oldSec = 0;
	var isDay = 1;
	var everySec = 1000, everyMin = 1000 * 60, everyHour = 1000 * 60 * 60;
	$(document).ready(function () {
		setUpClock();

		//setInterval(updateClock, everySec);
		setInterval(moveSunAndMoon, 1000);
	});

	/* Function set up all elements in position and then make them visible */
	function setUpClock() {
		getTime();
		//Fake hour to set objects in right place
		curHour--; curMin--; curSec--;
		oldHour = curHour - 1; oldMin = curMin - 1;	oldSec = curSec - 1;

		checkForHourlyChange();
		checkForMinChange();
		checkForSecChange();

		//TODO: maybe make this less crude :(
		getTime();

		$(".frame").show();
	}
	
	/* main clock logic */
	var updateClock = function() {
		getTime();
		checkForHourlyChange();
		checkForMinChange();
		checkForSecChange();
	}

	function getTime() {
		var now = new Date();
		curHour = now.getHours();
		curMin  = now.getMinutes();
		curSec  = now.getSeconds();
	}

	function checkForHourlyChange() {
		if (oldHour != curHour) {
			oldHour = curHour;
			//list of all functions to simulate passing hour
			moveSunAndMoon();
		}
		//else: nothing to do here
	}
	function checkForMinChange() {
		if (oldMin != curMin) {
			oldMin = curMin;
			//list of all functions to simulate passing min
		}
		//else: nothing to do here
	}
	function checkForSecChange() {
		/* every secon always passes test in current implementation
		if (oldSec != curSec) {
			oldSec = curSec;
			//list of all functions to simulate passing sec
		}
		*/
		//list of all functions to simulate passing sec
		windmillSecondTick();
	}

	var bladeAngle = 1;
	var bladeTickDuration = 100;
	function windmillSecondTick() {
		$("#blades").rotate({
			angle: bladeAngle,
			animateTo: bladeAngle + 20,
			duration: bladeTickDuration,
		});
		//handle angles > 360 deg
		bladeAngle = (bladeAngle + 20) % 360;
	}

	//using 13 hrs for animation [0-12]
	var noOfHours = 24;
	var moveAngle = 5;
	var moveSpeed = 200;
	var coorIdx = 0, nextCoorIdx = 0;
	var sunCoorX = [57, 85, 130, 185, 256, 346, 448, 535, 599,662,727,779,830,872,914,952,984];
	var sunCoorY = [442, 370, 305, 229, 160, 102, 65, 51, 60,72,97,125,158,197,241,286,341];
	var moonCoorX = [39, 92, 158, 238, 328, 434, 525, 618, 713, 797, 871, 932, 999];
	var moonCoorY = [420, 309, 219, 143, 85, 49, 36, 49, 83, 130, 198, 271, 403];
	var skyDayFadeAmount = [0, 0, 0, 0, 0.2, 0.4, 0.6, 0.8, 1, 1, 1, 1, 1, 1, 1, 1, 1,1, 0.8, 0.6, 0.4, 0.2, 0, 0, 0];
	var bezier_params = 0;
	var moveSunAndMoon = function () {

		displayTextTime();

		//check if within sun movement hours
		if (curHour > 5 && curHour < 22) {
			coorIdx = curHour - 6;
			nextCoorIdx = coorIdx + 1;

			bezier_params = {
				start: { x: sunCoorX[coorIdx], y: sunCoorY[coorIdx], angle: -moveAngle, length: 0.5 },
				end: { x: sunCoorX[nextCoorIdx], y: sunCoorY[nextCoorIdx], angle: moveAngle, length: 0.5 }
			}

			$("#sun").animate({ path: new $.path.bezier(bezier_params) }, moveSpeed);
		}

		//check if within  moon movement hours
		if (curHour > 18 || curHour < 7) {
			//handle hour change from 23 -> 0
			if (curHour > 18) {
				coorIdx = curHour - 19;
				nextCoorIdx = coorIdx + 1;
			} else {
				coorIdx = curHour + 5;
				nextCoorIdx = coorIdx + 1;
			}

			bezier_params = {
				start: { x: moonCoorX[coorIdx], y: moonCoorY[coorIdx], angle: -moveAngle, length: 0.5 },
				end: { x: moonCoorX[nextCoorIdx], y: moonCoorY[nextCoorIdx], angle: moveAngle, length: 0.5 }
			}

			$("#moon").animate({ path: new $.path.bezier(bezier_params) }, moveSpeed);
		}

		//handle lightening up and darkening sky
		$("#skyDay").fadeTo("slow", skyDayFadeAmount[curHour]);

		//debug 2 lines
		curHour++;
		curHour %= 24;
	}

	var displayTextTime = function () {
		$("#timeDisplay").text("" + curHour + ":" + curMin);
	}
</script>
<body>
	<div id="timeDisplay"> aaa</div>
	<div id="canvas">
		<div class="frame" id="skyDay">
			<img src="imgs/skyDay.png" />
		</div>
		<div class="frame" id="skyNight">
			<img src="imgs/skyNight.png" />
		</div>
		<div class="frame" id="bg">
			<img src="imgs/bg.png" />
		</div>
		<div class="frame" id="blades">
			<img src="imgs/blades.png" />
		</div>
		<div class="frame" id="sun">
			<img src="imgs/sun.png" />
		</div>
		<div class="frame" id="moon">
			<img src="imgs/moon.png" />
		</div>
	</div>
</body>
</html>